<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .tab-button.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transition: transform 0.2s ease-in-out; }
        .card:hover { transform: translateY(-5px); }
        .form-input { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); }
        .btn-primary { background-color: #4f46e5; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: background-color 0.3s; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #e5e7eb; color: #1f2937; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .page { display: none; }
        .page.active { display: block; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 400px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Login Page -->
    <div id="login-page" class="page active">
        <div class="flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md"><div class="card p-8 space-y-6"><div class="text-center"><h1 class="text-3xl font-bold text-gray-800">POS System Login</h1><p class="text-gray-500 mt-2">Please Log In</p></div><div id="customer-login-form"><h2 class="text-xl font-semibold text-center mb-4 text-gray-700">Customer Login</h2><div><label class="block text-sm font-medium text-gray-600 mb-1">Your Phone Number</label><input type="tel" id="customer-phone-login" class="form-input" placeholder="දුරකථන අංකය" required></div><button id="customer-login-btn" class="btn-primary w-full mt-4 text-lg py-3"><span class="material-icons">person</span>Login as Customer</button></div><div class="relative my-4"><div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center"><span class="bg-white px-2 text-sm text-gray-500">Or</span></div></div><div id="admin-login-form" class="hidden space-y-4"><h2 class="text-lg font-semibold text-center text-gray-600">Admin Login</h2><div><label class="block text-sm font-medium text-gray-600 mb-1">Username</label><input type="text" id="admin-username" class="form-input" value="admin"></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Password</label><input type="password" id="admin-password" class="form-input" value="password123"></div><button id="admin-login-btn" class="btn-primary w-full">Login as Admin</button></div><button id="show-admin-login-btn" class="w-full text-sm text-center text-indigo-600 hover:underline">Admin Login</button></div></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="page max-w-7xl mx-auto">
        <header class="mb-8 flex justify-between items-center"><h1 class="text-4xl font-bold text-gray-800">Admin Panel</h1><button id="admin-logout-btn" class="btn-secondary"><span class="material-icons">logout</span>Logout</button></header>
        <div class="flex justify-center mb-8 bg-gray-200 rounded-lg p-2 space-x-2"><button class="tab-button flex-1 py-2 px-4 rounded-md font-semibold active" onclick="showTab('stock')"><span class="material-icons align-middle mr-2">inventory_2</span>Stock</button><button class="tab-button flex-1 py-2 px-4 rounded-md font-semibold" onclick="showTab('sales')"><span class="material-icons align-middle mr-2">point_of_sale</span>Sales</button><button class="tab-button flex-1 py-2 px-4 rounded-md font-semibold" onclick="showTab('reports')"><span class="material-icons align-middle mr-2">assessment</span>Reports</button></div>
        <div id="stock" class="tab-content" style="display: block;"><div class="grid grid-cols-1 md:grid-cols-3 gap-8"><div class="md:col-span-1"><div class="card p-6"><h2 class="text-2xl font-bold mb-4 text-gray-700">Add New Item</h2><form id="add-stock-form" class="space-y-4"><div><label class="block text-sm font-medium text-gray-600 mb-1">Item ID</label><div class="flex items-center space-x-2"><input type="text" id="itemId" class="form-input" placeholder="භාණ්ඩ අංකය" required><button type="button" id="open-stock-scanner" class="p-2 bg-gray-200 rounded-md hover:bg-gray-300"><span class="material-icons">qr_code_scanner</span></button></div></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Price (LKR)</label><input type="number" id="itemPrice" class="form-input" placeholder="විකුණුම් මිල" required></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Cost (LKR)</label><input type="number" id="itemCost" class="form-input" placeholder="මිලදී ගත් මිල" required></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Supplier</label><input type="text" id="itemSupplier" class="form-input" placeholder="සැපයුම්කරු" required></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Picture</label><input type="file" id="itemPicture" class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept="image/*" required></div><button type="submit" class="btn-primary w-full"><span class="material-icons">add_shopping_cart</span>Add Item</button></form></div></div><div class="md:col-span-2"><div class="card p-6"><h2 class="text-2xl font-bold mb-4 text-gray-700">Current Stock</h2><div id="stock-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"><p class="text-gray-500 col-span-full">Loading stock...</p></div></div></div></div></div>
        <div id="sales" class="tab-content"><div class="grid grid-cols-1 md:grid-cols-3 gap-8"><div class="md:col-span-1"><div class="card p-6"><h2 class="text-2xl font-bold mb-4 text-gray-700">New Sale</h2><form id="add-sale-form" class="space-y-4"><div><label class="block text-sm font-medium text-gray-600 mb-1">Item ID</label><div class="flex items-center space-x-2"><input type="text" id="saleItemId" class="form-input" placeholder="භාණ්ඩ අංකය" required><button type="button" id="open-sale-scanner" class="p-2 bg-gray-200 rounded-md hover:bg-gray-300"><span class="material-icons">qr_code_scanner</span></button></div></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Customer Name</label><input type="text" id="customerName" class="form-input" placeholder="ගනුදෙනුකරුගේ නම" required></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Contact Number</label><input type="text" id="customerContact" class="form-input" placeholder="දුරකථන අංකය" required></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Payment Type</label><div class="flex space-x-4"><label class="flex items-center"><input type="radio" name="paymentType" value="full" class="mr-2" checked> Full Cash</label><label class="flex items-center"><input type="radio" name="paymentType" value="installment" class="mr-2"> Installment</label></div></div><div id="downpayment-section" class="hidden"><label class="block text-sm font-medium text-gray-600 mb-1">Downpayment (LKR)</label><input type="number" id="downpaymentAmount" class="form-input" placeholder="මූලික ගෙවීම"></div><button type="submit" class="btn-primary w-full"><span class="material-icons">shopping_cart</span>Create Sale</button></form></div></div><div class="md:col-span-2"><div class="card p-6"><h2 class="text-2xl font-bold mb-4 text-gray-700">Ongoing Sales</h2><div class="mb-4"><input type="text" id="sales-search" class="form-input" placeholder="Search by name, contact or Item ID..."></div><div id="sales-list" class="space-y-4"><p class="text-gray-500">Loading sales...</p></div></div></div></div></div>
        <div id="reports" class="tab-content"><div class="card p-6"><h2 class="text-2xl font-bold mb-4 text-gray-700">Sales Reports</h2><div class="flex flex-wrap gap-4 mb-6"><button id="report-daily" class="btn-secondary">Daily Report</button><button id="report-monthly" class="btn-secondary">Monthly Report</button><button id="report-annually" class="btn-secondary">Annual Report</button><button id="download-transactions-btn" class="btn-primary"><span class="material-icons">download</span>Download Transactions</button></div>
<div id="report-output" class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2" id="report-title">Select a report to view.</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-blue-100 rounded-lg">
                            <p class="text-sm text-blue-800">Total Sales</p>
                            <p class="text-2xl font-bold text-blue-900" id="report-total-sales">0</p>
                        </div>
                         <div class="text-center p-4 bg-green-100 rounded-lg">
                            <p class="text-sm text-green-800">Total Revenue</p>
                            <p class="text-2xl font-bold text-green-900" id="report-total-revenue">LKR 0</p>
                        </div>
                         <div class="text-center p-4 bg-yellow-100 rounded-lg">
                            <p class="text-sm text-yellow-800">Total Cost</p>
                            <p class="text-2xl font-bold text-yellow-900" id="report-total-cost">LKR 0</p>
                        </div>
                        <div class="text-center p-4 bg-red-100 rounded-lg">
                            <p class="text-sm text-red-800">Total Profit</p>
                            <p class="text-2xl font-bold text-red-900" id="report-total-profit">LKR 0</p>
                        </div>
                    </div>
                </div></div><div class="card p-6 mt-8"><h2 class="text-2xl font-bold mb-4 text-gray-700">Available Stock Details</h2><button id="download-stock-btn" class="btn-primary mb-4"><span class="material-icons">download</span>Download Stock Report</button><div id="stock-report-list" class="space-y-2"></div></div></div>
    </div>
    
    <!-- Customer Dashboard -->
    <div id="customer-dashboard" class="page max-w-4xl mx-auto">
         <header class="mb-8 flex justify-between items-center"><div><h1 id="customer-welcome-name" class="text-4xl font-bold text-gray-800">Welcome!</h1><p id="customer-info-contact" class="text-gray-500 mt-2">Your sales dashboard.</p></div><button id="customer-logout-btn" class="btn-secondary"><span class="material-icons">logout</span>Logout</button></header>
        <div id="outstanding-balance-card" class="card p-6 mb-8 bg-amber-100 border-amber-400 border hidden"><h2 class="text-xl font-bold text-amber-800">Outstanding Balance</h2><p id="outstanding-balance-amount" class="text-3xl font-bold text-amber-900 mt-2">LKR 0.00</p></div>
        <div class="card p-6"><h2 class="text-2xl font-bold mb-4 text-gray-700">Your Purchases</h2><div id="customer-sales-list" class="space-y-4"></div></div>
    </div>

    <!-- Modals -->
    <div id="scanner-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold text-center mb-4">Scan Barcode / QR Code</h3><div id="reader" width="100%"></div><button id="close-scanner" class="btn-secondary w-full mt-4">Close Camera</button></div></div>
    <div id="edit-sale-modal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Edit Customer Info</h3><form id="edit-sale-form" class="space-y-4"><input type="hidden" id="edit-sale-key"><div><label class="block text-sm font-medium text-gray-600 mb-1">Customer Name</label><input type="text" id="edit-customerName" class="form-input" required></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Contact Number</label><input type="text" id="edit-customerContact" class="form-input" required></div><div class="flex justify-end space-x-3 mt-4"><button type="button" id="close-edit-modal-btn" class="btn-secondary">Cancel</button><button type="submit" class="btn-primary">Save Changes</button></div></form></div></div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"><p id="toast-message"></p></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAfIder_grSB7gRcS2Ko951DsGqxWswjjI", authDomain: "thinethhelthcare.firebaseapp.com", databaseURL: "https://thinethhelthcare-default-rtdb.firebaseio.com", projectId: "thinethhelthcare", storageBucket: "thinethhelthcare.firebasestorage.app", messagingSenderId: "477694167976", appId: "1:477694167976:web:f6c9b3459bbaa218faab9d" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        
        let html5QrCode, currentScannerInput = null, allSalesData = [];

        function showPage(pageId) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); }
        function showToast(message, isError = false) { const t = document.getElementById('toast'); t.children[0].textContent = message; t.classList.remove('opacity-0'); t.style.backgroundColor = isError ? '#ef4444' : '#1f2937'; setTimeout(() => t.classList.add('opacity-0'), 3000); }
        function showTab(tabId) { document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none'); document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active')); document.getElementById(tabId).style.display = 'block'; document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active'); }
        function logout() { showPage('login-page'); }

        document.getElementById('show-admin-login-btn').addEventListener('click', () => { document.getElementById('admin-login-form').classList.remove('hidden'); document.getElementById('customer-login-form').classList.add('hidden'); document.getElementById('show-admin-login-btn').classList.add('hidden'); });
        document.getElementById('admin-login-btn').addEventListener('click', () => { 
            const passwordInput = document.getElementById('admin-password');
            if (document.getElementById('admin-username').value === 'admin' && passwordInput.value === 'eglviraj') { 
                showPage('admin-panel'); 
                fetchAndDisplayStock(); 
                fetchAndDisplaySales(); 
                renderStockReport(); 
            } else { 
                showToast('Invalid admin credentials.', true); 
            }
            passwordInput.value = '';
        });
        document.getElementById('customer-login-btn').addEventListener('click', async () => { const phone = document.getElementById('customer-phone-login').value.trim(); if (!phone) return showToast('Please enter phone number.', true); try { const s = await database.ref('sales').orderByChild('customerContact').equalTo(phone).once('value'); if (s.val()) { populateCustomerDashboard(s.val()); showPage('customer-dashboard'); } else { showToast('No sales found.', true); } } catch (e) { showToast("Could not log in.", true); } });
        document.getElementById('admin-logout-btn').addEventListener('click', logout);
        document.getElementById('customer-logout-btn').addEventListener('click', logout);

        function openScanner(inputId) { currentScannerInput = inputId; document.getElementById('scanner-modal').style.display = 'flex'; html5QrCode = new Html5Qrcode("reader"); html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (d) => { if (currentScannerInput) document.getElementById(currentScannerInput).value = d; closeScanner(); showToast(`Scanned: ${d}`); }, (e) => {}).catch(err => console.log('Unable to start scanning.', err)); }
        function closeScanner() { if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().catch(err => {}); } document.getElementById('scanner-modal').style.display = 'none'; }
        document.getElementById('open-stock-scanner').addEventListener('click', () => openScanner('itemId'));
        document.getElementById('open-sale-scanner').addEventListener('click', () => openScanner('saleItemId'));
        document.getElementById('close-scanner').addEventListener('click', closeScanner);

        document.getElementById('add-stock-form').addEventListener('submit', async (e) => { e.preventDefault(); const itemId = e.target.itemId.value.trim(), price = e.target.itemPrice.value, cost = e.target.itemCost.value, supplier = e.target.itemSupplier.value.trim(), file = e.target.itemPicture.files[0]; if (!itemId || !price || !cost || !supplier || !file) return showToast("Please fill all fields.", true); try { const ref = storage.ref(`stock-images/${itemId}-${file.name}`); const url = await (await ref.put(file)).ref.getDownloadURL(); await database.ref('stock/' + itemId).set({ itemId, price: parseFloat(price), cost: parseFloat(cost), supplier, imageUrl: url }); showToast("Stock item added!"); e.target.reset(); } catch (err) { showToast("Failed to add item.", true); } });
        function fetchAndDisplayStock() { database.ref('stock').on('value', (s) => { const list = document.getElementById('stock-list'); list.innerHTML = ''; if (s.val()) { Object.values(s.val()).forEach(i => { list.innerHTML += `<div class="border rounded-lg p-4 bg-white shadow-sm"><img src="${i.imageUrl}" class="w-full h-32 object-cover rounded-md mb-2"><h3 class="font-bold text-lg">${i.itemId}</h3><p class="text-indigo-600 font-semibold">LKR ${i.price.toFixed(2)}</p><p class="text-sm text-gray-500">Supplier: ${i.supplier}</p></div>`; }); } else { list.innerHTML = '<p>No stock items.</p>'; } }); }

        document.querySelectorAll('input[name="paymentType"]').forEach(r => r.addEventListener('change', (e) => { document.getElementById('downpayment-section').classList.toggle('hidden', e.target.value !== 'installment'); }));
        document.getElementById('add-sale-form').addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; const itemId = form.saleItemId.value.trim(), name = form.customerName.value.trim(), contact = form.customerContact.value.trim(), type = form.paymentType.value, downpayment = form.downpaymentAmount.value; if (!itemId || !name || !contact) return showToast("Fill required fields.", true); try { const stock = (await database.ref('stock/' + itemId).once('value')).val(); if (!stock) return showToast("Item not in stock.", true); const saleData = { itemId, customerName: name, customerContact: contact, paymentType: type, saleDate: new Date().toISOString(), totalPrice: stock.price, payments: {}, status: 'complete' }; if (type === 'installment') { const dp = parseFloat(downpayment); if (!downpayment || dp >= stock.price || dp <= 0) return showToast("Invalid downpayment.", true); saleData.payments[database.ref().push().key] = { amount: dp, date: new Date().toISOString() }; saleData.status = 'ongoing'; } else { saleData.payments[database.ref().push().key] = { amount: stock.price, date: new Date().toISOString() }; } await database.ref('sales').push(saleData); showToast("Sale created!"); form.reset(); document.getElementById('downpayment-section').classList.add('hidden'); } catch (err) { showToast("Failed to create sale.", true); console.error(err); } });
        async function updatePayment(key, inputId) { const amountStr = document.getElementById(inputId).value; const amount = parseFloat(amountStr); if (isNaN(amount) || amount <= 0) return showToast("Invalid amount.", true); const saleRef = database.ref('sales/' + key); try { const sale = (await saleRef.once('value')).val(); if (!sale) return showToast("Sale not found.", true); const totalPaid = Object.values(sale.payments || {}).reduce((sum, p) => sum + p.amount, 0); if (totalPaid + amount > sale.totalPrice) return showToast("Payment exceeds balance.", true); await database.ref(`sales/${key}/payments`).push({ amount: amount, date: new Date().toISOString() }); const newTotalPaid = totalPaid + amount; if (newTotalPaid >= sale.totalPrice) await saleRef.update({ status: 'complete' }); showToast("Payment updated!"); } catch (e) { showToast("Failed to update.", true); } }
        
        const editModal = document.getElementById('edit-sale-modal');
        function openEditModal(key, name, contact) { editModal.querySelector('#edit-sale-key').value = key; editModal.querySelector('#edit-customerName').value = name; editModal.querySelector('#edit-customerContact').value = contact; editModal.style.display = 'flex'; }
        document.getElementById('close-edit-modal-btn').addEventListener('click', () => editModal.style.display = 'none');
        document.getElementById('edit-sale-form').addEventListener('submit', async (e) => { e.preventDefault(); const key = e.target['edit-sale-key'].value; const name = e.target['edit-customerName'].value; const contact = e.target['edit-customerContact'].value; await database.ref(`sales/${key}`).update({ customerName: name, customerContact: contact }); showToast('Customer info updated!'); editModal.style.display = 'none'; });

        function fetchAndDisplaySales() { database.ref('sales').on('value', async (snap) => { const stock = (await database.ref('stock').once('value')).val(); allSalesData = []; if (snap.val() && stock) { for(const key in snap.val()){ const sale = snap.val()[key]; if(stock[sale.itemId]) allSalesData.push({ key, ...sale, itemDetails: stock[sale.itemId] }); } allSalesData.reverse(); renderSales(allSalesData); } else { document.getElementById('sales-list').innerHTML = '<p>No sales found.</p>'; } }); }
        function renderSales(sales) { const list = document.getElementById('sales-list'); list.innerHTML = ''; if (sales.length === 0) { list.innerHTML = '<p>No matching sales.</p>'; return; } sales.forEach(s => { const totalPaid = Object.values(s.payments || {}).reduce((sum, p) => sum + p.amount, 0); const isComplete = s.status === 'complete'; let paymentInfo = '', paymentHistory = ''; if(s.payments) { paymentHistory = `<div class="text-xs text-gray-500 mt-2 space-y-1">` + Object.values(s.payments).map(p => `<div>- Paid LKR ${p.amount.toFixed(2)} on ${new Date(p.date).toLocaleDateString()}</div>`).join('') + `</div>`; } if (!isComplete) { const rem = s.totalPrice - totalPaid; paymentInfo = `<p class="text-sm text-red-600 font-semibold mt-2">Rem: LKR ${rem.toFixed(2)}</p><div class="mt-2 flex space-x-2"><input type="number" id="payment-${s.key}" class="form-input !w-auto flex-grow" placeholder="Amount"><button onclick="updatePayment('${s.key}', 'payment-${s.key}')" class="btn-primary !px-3 !py-2"><span class="material-icons">payment</span></button></div>`; } list.innerHTML += `<div class="flex items-start p-4 border rounded-lg bg-white space-x-4"><img src="${s.itemDetails.imageUrl}" class="w-20 h-20 object-cover rounded-md flex-shrink-0"><div class="flex-grow"><div><div class="flex justify-between items-center"><h4 class="font-bold">${s.customerName}</h4><span class="px-2 py-1 text-xs font-semibold rounded-full ${isComplete ? 'text-green-800 bg-green-200' : 'text-yellow-800 bg-yellow-200'}">${s.status}</span></div><button onclick="openEditModal('${s.key}', '${s.customerName}', '${s.customerContact}')" class="text-xs text-indigo-500 hover:underline">edit</button></div><p class="text-sm text-gray-600">${s.customerContact}</p><p class="text-sm font-mono bg-gray-100 inline-block px-2 py-0.5 rounded mt-1">${s.itemId}</p>${paymentHistory}${paymentInfo}</div></div>`; }); }
        document.getElementById('sales-search').addEventListener('input', (e) => { const term = e.target.value.toLowerCase(); renderSales(allSalesData.filter(s => s.customerName.toLowerCase().includes(term) || s.customerContact.toLowerCase().includes(term) || s.itemId.toLowerCase().includes(term))); });

        async function populateCustomerDashboard(data) { const list = document.getElementById('customer-sales-list'); list.innerHTML = ''; let name, contact, outstanding = 0; const stock = (await database.ref('stock').once('value')).val() || {}; const sales = Object.values(data).reverse(); if (sales.length > 0) { name = sales[0].customerName; contact = sales[0].customerContact; document.getElementById('customer-welcome-name').textContent = `Welcome, ${name}`; document.getElementById('customer-info-contact').textContent = contact; } sales.forEach(s => { const item = stock[s.itemId]; if (!item) return; const totalPaid = Object.values(s.payments || {}).reduce((sum, p) => sum + p.amount, 0); let balanceInfo = ''; if (s.status === 'ongoing') { const bal = s.totalPrice - totalPaid; outstanding += bal; balanceInfo = `<p class="text-sm font-semibold text-red-600 mt-2">Balance: LKR ${bal.toFixed(2)}</p>`; } let paymentHistory = `<div class="text-xs text-gray-500 mt-2 space-y-1 border-t pt-2">` + Object.values(s.payments || {}).map(p => `<div>- Paid LKR ${p.amount.toFixed(2)} on ${new Date(p.date).toLocaleDateString()}</div>`).join('') + `</div>`; list.innerHTML += `<div class="flex items-start p-4 border rounded-lg bg-white space-x-4"><img src="${item.imageUrl}" class="w-20 h-20 object-cover rounded-md flex-shrink-0"><div class="flex-grow"><div class="flex justify-between items-center"><h4 class="font-bold">${item.itemId}</h4><span class="text-lg font-semibold text-indigo-600">LKR ${s.totalPrice.toFixed(2)}</span></div><p class="text-sm text-gray-500">Purchased: ${new Date(s.saleDate).toLocaleDateString()}</p>${balanceInfo}${paymentHistory}</div></div>`; }); const card = document.getElementById('outstanding-balance-card'); if(outstanding > 0) { card.querySelector('p').textContent = `LKR ${outstanding.toFixed(2)}`; card.classList.remove('hidden'); } else { card.classList.add('hidden'); } }

        async function generateReport(period) { const sales = (await database.ref('sales').once('value')).val() || {}; const stock = (await database.ref('stock').once('value')).val() || {}; const now = new Date(); const filtered = Object.values(sales).filter(s => { const d = new Date(s.saleDate); if (period === 'daily') return d.toDateString() === now.toDateString(); if (period === 'monthly') return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth(); if (period === 'annually') return d.getFullYear() === now.getFullYear(); return false; }); let totalSales = filtered.length, revenue = 0, cost = 0; filtered.forEach(s => { revenue += s.totalPrice; if (stock[s.itemId]) cost += stock[s.itemId].cost; }); document.getElementById('report-title').textContent = `${period.charAt(0).toUpperCase() + period.slice(1)} Report`; document.getElementById('report-total-sales').textContent = totalSales; document.getElementById('report-total-revenue').textContent = `LKR ${revenue.toFixed(2)}`; document.getElementById('report-total-cost').textContent = `LKR ${cost.toFixed(2)}`; document.getElementById('report-total-profit').textContent = `LKR ${(revenue - cost).toFixed(2)}`; }
        document.getElementById('report-daily').addEventListener('click', () => generateReport('daily')); document.getElementById('report-monthly').addEventListener('click', () => generateReport('monthly')); document.getElementById('report-annually').addEventListener('click', () => generateReport('annually'));
        
        function downloadFile(content, filename) { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content], {type: "text/plain"})); a.setAttribute('download', filename); a.click(); }
        document.getElementById('download-transactions-btn').addEventListener('click', () => { let content = 'Transaction Report\n==================\n\n'; allSalesData.forEach(s => { content += `Date: ${new Date(s.saleDate).toLocaleString()}\nCustomer: ${s.customerName} (${s.customerContact})\nItem: ${s.itemId}\nTotal: LKR ${s.totalPrice.toFixed(2)}\nStatus: ${s.status}\n\n`; }); downloadFile(content, 'transactions.txt'); });
        document.getElementById('download-stock-btn').addEventListener('click', async () => { const stock = (await database.ref('stock').once('value')).val() || {}; let content = 'Stock Report\n==============\n\nID\t\tPrice\t\tSupplier\n--------------------------------\n'; Object.values(stock).forEach(i => { content += `${i.itemId}\t\tLKR ${i.price.toFixed(2)}\t\t${i.supplier}\n`; }); downloadFile(content, 'stock_report.txt'); });
        async function renderStockReport() { const list = document.getElementById('stock-report-list'); list.innerHTML = `<div class="grid grid-cols-3 font-bold border-b pb-2"><p>Item ID</p><p>Price</p><p>Supplier</p></div>`; const stock = (await database.ref('stock').once('value')).val() || {}; Object.values(stock).forEach(i => { list.innerHTML += `<div class="grid grid-cols-3 py-1 border-b"><p>${i.itemId}</p><p>LKR ${i.price.toFixed(2)}</p><p>${i.supplier}</p></div>`; }); }
    </script>
</body>
</html>


